# 启元人工智能大赛 推理系统报告

<!--
人工智能系统大赛推理系统赛道提交需要一个《技术报告》，包括技术方案设计、结果验证分析报告、模型推理效果截图。

报告提交方式：
报告提交和作品一起通过PR提交（可以附件形式）

报告内容：

包含但不限于已实现技术亮点、成果阐述、可行性应用场景等。

提交PR可以根据提交记录更好理清作品时间线，做好溯源，防止抄袭。
-->

## 1. 参与赛道

**九源大模型推理引擎开发**
<!--
模型适配赛题
推理系统优化赛题
量化模型推理赛题
-->
参与了量化模型推理赛题 选用InfiniCore-Infer框架，量化推理九格-4B模型

## 2. 成果阐述

使用llama.cpp对fm9g-4B-sft-v1.0-F16.gguf完成Q8量化，jiexitiqu.py成功解析fm9g-4B-sft-v1.0-Q8_0.gguf模型，提取Q8_0量化权重，建立了完整的GGUF到InfiniCore的权重映射体系。

## 3. 技术亮点
**高效的二进制解析**：实现了对齐到32字节边界的数据区定位算法\
**鲁棒的错误处理**：对NaN和无穷大缩放因子的检测与处理\
**分块读取策略**：支持大规模权重的流式处理，避免内存溢出\
**可视化分析工具**：提供了详细的量化分布和压缩效率分析
### 3.1 GGUF格式深度解析器
成功实现了对GGUF文件结构的完整解析，包括：
- **文件头解析**：支持GGUF v3版本，正确识别魔数（0x47475546）和版本信息
- **元数据提取**：解析30项关键元数据，包含模型架构、词汇表大小、上下文长度等
- **张量信息解析**：成功处理374个张量的维度、数据类型和偏移量信息
- **架构参数提取**：完整提取LLaMA架构的62层Transformer结构参数，2560嵌入维度，40注意力头
### 3.2 Q8_0量化权重提取技术
突破性地实现了Q8_0量化格式的精确解析：
- **量化结构理解**：每32个权重为一组，包含1个FP16缩放因子和32个int8权重值
- **数据提取算法**：成功提取所有量化块
- **压缩效率分析**：相比FP16实现1.88倍压缩，节省46.8%存储空间
### 3.3 权重映射与转换
建立了完整的GGUF到InfiniCore的权重映射体系：
- 输入嵌入层：`token_embd.weight` → `input_embd`
- 注意力层：`blk.N.attn_qkv.weight` → `attn_qkv.N`
- FFN层：`blk.N.ffn_gate_up.weight` → `ffn_gate_up.N`
- 成功映射373个权重张量，覆盖模型全部层级
## 4. 性能结果

<!-- 测试命令、性能数据、提升情况及截图 -->
测试命令：srun -w gpua18 --gres=gpu:1 --time=00:20:00     python ./InfiniLM/try/jiexitiqu.py     ./fm9g-4B-sft-v1.0-Q8_0.gguf     --extract-weights     --output-dir ./my_weights     --save-report

执行./try/jiexitiqu.py 后终端的输出内容保存在./try/jiexitiqu终端输出.txt

GGUF文件结构深度分析报告储存在./try/fm9g-4B-sft-v1.0-Q8_0_structure_analysis.json

专门用于提取 blk.61.ffn_gate_up.weight 张量的独立脚本extract_blk61.py和其执行结61blk.txt保存在./try目录下
### 4.1 处理效率
- 文件解析速度：4.09GB文件完整解析耗时约3分钟
- 权重提取速度：373个张量并行提取，总耗时约5分钟
- 存储效率：Q8_0相比FP16节省46.8%存储空间

### 4.2 精度保证
- Q8_0量化精度：8位整数表示，配合FP16缩放因子
- 权重值分布：均值0.56，标准差54.94，保持了良好的数值分布
- 稀疏度：0.74%，有效保留了模型的稀疏特性

## 5. 时间线

<!-- 大致列出时间线，包括 知识学习、技术调研、环境、编码、测试等大致时间点 -->
7月21日 - 7月29日：技术调研阶段

了解InfiniCore框架接口\
研究GGUF文件格式规范\
学习llama.cpp量化原理

8月1日 - 8月5日：环境搭建与初步测试

配置llama.cpp编译环境\
完成fm9g模型的初步量化测试\
验证Q8_0量化效果

7月29日 - 8月5日：核心开发阶段

实现GGUF文件头解析\
开发元数据提取功能\
完成张量信息解析模块

8月9日 - 8月24日：权重提取实现

实现Q8_0权重数据提取\
开发FP32/FP16权重提取\
提取 blk.61.ffn_gate_up.weight 张量时遇到报错读取到文件末尾，撰写专门用于提取 blk.61.ffn_gate_up.weight 张量的独立脚本\
完成权重保存功能

8月9日 - 8月24日：InfiniCore集成

设计权重名称映射规则\
实现自动映射系统\
生成标准化配置文件

8月24日：最终提交

代码整理\
报告撰写\
成果提交

<!-- 完 -->